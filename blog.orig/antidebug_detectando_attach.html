<!DOCTYPE html>
<html lang="en-us" dir="ltr" itemscope itemtype="http://schema.org/Article">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Blogue do Caloni</title>
<meta name="author" content="Caloni" />
<meta name="generator" content="https://github.com/caloni/journal">
<meta property="og:title" content="Blogue do Caloni"/>
<meta property="og:type" content="website"/>
<meta property="og:url" content="http://www.caloni.com.br"/>
<meta property="og:image" content="/blog/img/about-brand.png"/>
<meta property="og:description" content="Write for computers, people and food."/>
<link href="/blog/index.xml" rel="feed" type="application/rss+xml" title="Blogue do Caloni"/>
<link rel="stylesheet" type="text/css" href="/blog/css/custom.css"/>
<link rel="stylesheet" type="text/css" href="/blog/css/jquery-ui.css"/>
<script src="/blog/js/jquery-1.12.4.js"></script>
<script src="/blog/js/jquery-ui.js"></script>
<script src="/blog/js/copy_clipboard.js"></script>
<script src="/blog/js/list.js"></script>
<link rel="icon" href="/blog/img/favicon.ico"/>
</head>
<body style="min-height:100vh;display:flex;flex-direction:column">
<nav class="navbar has-shadow is-white"
role="navigation" aria-label="main navigation">
<div class="container">
<div class="navbar-brand">
&nbsp;
<a class="navbar-item" href="index.html">
<div class="is-4"><b>Blogue do Caloni</b></div>
</a>
</div>
</div>
</nav>
<div class="container">
<div class="column">
<div style="min-height:56vh">
<div style="padding-bottom: 1em;"></div>
<span id="antidebug_detectando_attach" title="Antidebug: Detectando Attach"/></span>
<section id="section_antidebug_detectando_attach">
<p class="title">Antidebug: Detectando Attach</p>
<span class="title-heading">Caloni, 2007-09-10 computer projects antidebug blog</span>

<p>Hoje foi um belo dia para engenharia reversa e análise de proteções. Dois ótimos programas vieram ao meu conhecimento: um monitor de chamadas de API e um monitor de chamadas de COM (complementando o primeiro, que não monitora funções depois que CoCreateInstance foi chamado). Além de que no site do primeiro programa - de algum entusiasta do bom e velho Assembly Win32, diga-se de passagem - encontrei o código-fonte para mais uma técnica antidebugging, o que nos leva de volta para a já consagrada série de técnicas antidepuração.</p>

<blockquote>Update 2026-01-31: estes sites já não existe mais, então removi os links.</blockquote>
<p>O objetivo dessa proteção é detectar se, após o executável ter sido iniciado, algum depurador metido a besta tentou atachar-se no processo criado, ou seja, tentou iniciar o processo de depuração após o aplicativo já ter iniciada a execução. Isso é possível - de certa forma trivial - na maioria dos depuradores (se não todos), como o Visual Studio e o WinDbg. Diferente da técnica de ocupar a DebugPort, que impede a ação de attach, a proteção nesse caso não protege diretamente; apenas permite que o processo saiba do suposto ataque antes de entregar o controle ao processo depurador.</p>

<p>O código que eu encontrei nada mais faz do que se aproveitar de uma peculiaridade do processo de attach: ao disparar o evento, a função ntdll!DbgUiRemoteBreakin é chamada. Ora, se é chamada, é lá que devemos estar, certo? O código, então, insere um breakpoint hardcoded no início dessa função para capturar esse evento. Update 2026-01-31: este código não está mais disponível, mas graças ao Chat-GPT foi fácil reconstruí-lo. Optei por uma versão em C puro:</p>

<pre>
void InstallAntiAttach(void)
{
    HMODULE hNtdll;
    BYTE *pBreakin;
    DWORD oldProtect;
    DWORD rel;
    hNtdll = GetModuleHandleA(&quot;ntdll.dll&quot;);
    if (!hNtdll)
        return;
    pBreakin = (BYTE *)GetProcAddress(
        hNtdll,
        &quot;DbgUiRemoteBreakin&quot;
    );
    if (!pBreakin)
        return;
    // make memory executable and writable
    VirtualProtect(
        pBreakin,
        5,
        PAGE_EXECUTE_READWRITE,
        &amp;oldProtect
    );
    // JMP rel32
    pBreakin[0] = 0xE9;
    // relative offset
    rel = (DWORD)AntiAttachAbort -
          (DWORD)pBreakin - 5;
    *(DWORD *)(pBreakin + 1) = rel;
    // restore protection
    VirtualProtect(
        pBreakin,
        5,
        oldProtect,
        &amp;oldProtect
    );
}
</pre>
<p>O AntiAttachAbort pode ser uma função singela:</p>

<pre>
void WINAPI AntiAttachAbort(void)
{
    MessageBoxA(
        NULL,
        &quot;Debugger detectado via attach!&quot;,
        &quot;AntiAttach&quot;,
        MB_ICONERROR | MB_OK
    );
    ExitProcess(0);
}
</pre>
<p>Existem inúmeras maneiras de fazer a mesma coisa. A alternativa original é o que era chamado comumente nas rodinhas de crackers de shellcode, que é um nome bonitinho para "array de bytes que na verdade é um assembly de um código que faz coisas interessantes". Shellcode for short =).</p>

<p>Maneiras alternativas de fazer isso são:</p>

<p>  1. Declarar uma função _naked_ no Visual Studio, criar uma função vazia logo após e fazer continha de mais e menos para chegar ao tamanho que deve ser copiado.</p>

<p>  2. Criar uma estrutura cujos membros são _opcodes_ disfarçados. Dessa forma é possível no construtor dessa estrutura preencher os valores corretamente e usá-la como uma "função móvel".</p>

<p>Ambas possuem prós e contras. Os contras estão relacionados com a dependência do ambiente. Na primeira alternativa é necessário configurar o projeto para desabilitar o "Edit and Continue", enquanto no segundo é necessário alinhar a estrutura em 1 byte.</p>

<p>Seja qual for a solução escolhida, ao menos temos a vantagem do impacto no sistema de nosso aplicativo ser praticamente nulo, pois isolamos em duas funções - AntiAttachAbort e InstallAntiAttach - um hook de uma API local (do próprio processo) que supostamente nunca deveria ser chamada em um binário de produção. Além do mais, existem maneiras mais a la C++ de fazer coisas como "live assembly". Mas isso já é matéria para futuros e excitantes artigos =D.</p>

</section>

<span style="float: left;">
 <a href="aquisicao_de_recurso_e_inicializacao.html">[aquisicao_de_recurso_e_inicializacao]</a>
 <a href="barata_eletrica_e_o_hacker_de_antigamente.html">[barata_eletrica_e_o_hacker_de_antigamente]</a>
</span>
</div>
</div>
</section>
<footer class="footer">
<div class="container">
</div>
<div class="intentionally-blank"></div>
</footer>
</body>
</html>
