<!DOCTYPE html>
<html lang="en-us" dir="ltr" itemscope itemtype="http://schema.org/Article">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Blogue do Caloni</title>
<meta name="author" content="Caloni" />
<meta name="generator" content="https://github.com/caloni/journal">
<meta property="og:title" content="Blogue do Caloni"/>
<meta property="og:type" content="website"/>
<meta property="og:url" content="http://www.caloni.com.br"/>
<meta property="og:image" content="/blog/img/about-brand.png"/>
<meta property="og:description" content="Write for computers, people and food."/>
<link href="/blog/index.xml" rel="feed" type="application/rss+xml" title="Blogue do Caloni"/>
<link rel="stylesheet" type="text/css" href="/blog/css/custom.css"/>
<link rel="stylesheet" type="text/css" href="/blog/css/jquery-ui.css"/>
<script src="/blog/js/jquery-1.12.4.js"></script>
<script src="/blog/js/jquery-ui.js"></script>
<script src="/blog/js/copy_clipboard.js"></script>
<script src="/blog/js/list.js"></script>
<link rel="icon" href="/blog/img/favicon.ico"/>
</head>
<body style="min-height:100vh;display:flex;flex-direction:column">
<nav class="navbar has-shadow is-white"
role="navigation" aria-label="main navigation">
<div class="container">
<div class="navbar-brand">
&nbsp;
<a class="navbar-item" href="index.html">
<div class="is-4"><b>Blogue do Caloni</b></div>
</a>
</div>
</div>
</nav>
<div class="container">
<div class="column">
<div style="min-height:56vh">
<div style="padding-bottom: 1em;"></div>
<span id="bug_no_retorno_do_pathisdirectory" title="Bug no retorno do PathIsDirectory"/></span>
<section id="section_bug_no_retorno_do_pathisdirectory">
<p class="title">Bug no retorno do PathIsDirectory</p>
<span class="title-heading">Caloni, 2008-09-10 computer blog</span>

<p>Estava eu outro dia programando aquele código esperto "para ontem" quando me deparei com uma situação no mínimo inusitada. Ao testar se um caminho recebido era de fato um diretório me foi retornado pela API um valor diferente de TRUE. E diferente de FALSE!</p>

<p>De acordo com a documentação, o retorno deveria ser TRUE caso o caminho enviado à função fosse de fato um diretório. Caso contrário, o retorno deveria ser FALSE.</p>

<p>Note que existem apenas dois valores possíveis para essa função. Porém, o valor retornado não é 1, o equivalente ao define TRUE, mas sim 0x10 (16 em hexadecimal). O simples exemplo abaixo deve conseguir reproduzir a situação (Windows XP Service Pack 3):</p>

<pre>
   Setting environment for using Microsoft Visual Studio 2008 x86 tools.
   C:\Tests&gt;copy con IsPathDir.cpp
   #include &lt;shlwapi.h&gt;
   #include &lt;windows.h&gt;
   #include &lt;stdio.h&gt;
   #pragma comment(lib, &quot;shlwapi.lib&quot;)
   int main()
   {
           BOOL isDir = PathIsDirectory(&quot;C:\\Tests&quot;); // obs.: diretorio TEM que existir
           printf(&quot;Resultado: %d.\n&quot;, isDir);
   }^Z
           1 arquivo(s) copiado(s).
   C:\Tests&gt;cl IsPathDir.cpp
   Microsoft (R) 32-bit C/C++ Optimizing Compiler Version 15.00.21022.08 for 80x86
   Copyright (C) Microsoft Corporation.  All rights reserved.
   IsPathDir.cpp
   Microsoft (R) Incremental Linker Version 9.00.21022.08
   Copyright (C) Microsoft Corporation.  All rights reserved.
   /out:IsPathDir.exe
   IsPathDir.obj
   C:\Tests&gt;IsPathDir.exe
   Resultado: 16.
</pre>
<p>Isso quer dizer apenas que o código abaixo vai funcionar,</p>

<pre>
   if( PathIsDirectory(path) ) // legal: qualquer coisa diferente de zero
</pre>
<p>o código abaixo vai funcionar</p>

<pre>
   if( ! PathIsDirectory(path) ) // legal: se der zero (FALSE), OK
</pre>
<p>e o código abaixo não vai funcionar:</p>

<pre>
   if( PathIsDirectory(path) == TRUE ) // vixi: TRUE nem sempre é o resultado
</pre>
<p>E, pior, o código abaixo também não vai funcionar!</p>

<pre>
   if( PathIsDirectory(path) != TRUE ) // aff... é bom rever os seus conceitos
</pre>
<p>Pesquisando um pouco descobri uma boa discussão sobre o tema, e inclusive que outras pessoas descobriram o interessante detalhe que para pastas normais o retorno é 0x10, mas para compartilhamentos o retorno é 0x1.</p>

<h4>O bug atrás dos documentos</h4>

<p>O problema ocorre por causa da maneira que a função determina se o caminho é um diretório ou não. Uma simples vistoria sobre a função nos revela o detalhe crucial:</p>

<pre>
   C:\Tests&gt;cl /Zi IsPathDir.cpp
   Microsoft (R) 32-bit C/C++ Optimizing Compiler Version 15.00.21022.08 for 80x86
   Copyright (C) Microsoft Corporation.  All rights reserved.
   IsPathDir.cpp
   Microsoft (R) Incremental Linker Version 9.00.21022.08
   Copyright (C) Microsoft Corporation.  All rights reserved.
   /out:IsPathDir.exe
   /debug
   IsPathDir.obj
   C:\Tests&gt;cdb IsPathDir.exe
   Microsoft (R) Windows Debugger Version 6.8.0004.0 X86
   Copyright (c) Microsoft Corporation. All rights reserved.
   CommandLine: IsPathDir.exe
   Symbol search path is: SRV*c:\symbols*http://msdl.microsoft.com/download/symbols
   ...
   ntdll!DbgBreakPoint:
   7c901230 cc              int     3
   0:000&gt; g shlwapi!PathIsDirectoryA
   eax=009836e0 ebx=7ffde000 ecx=00000001 edx=00422828 esi=0006f4cc edi=7c911970
   eip=77ee7538 esp=0012ff6c ebp=0012ff78 iopl=0         nv up ei pl zr na pe nc
   cs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00000246
   SHLWAPI!PathIsDirectoryA:
   77ee7538 8bff            mov     edi,edi
   0:000&gt; p
   push    ebp
   mov     ebp,esp
   sub     esp,20Ch
   mov     eax,dword ptr [SHLWAPI!__security_cookie
   push    esi
   mov     esi,dword ptr [ebp+8] ss:0023:0012ff70=0041dc5c
   test    esi,esi
   mov     dword ptr [ebp-4],eax ss:0023:0012ff64=fffffffe
   je      SHLWAPI!PathIsDirectoryA+0xb2 (77ee75ea) [br=0]
   push    esi
   call    SHLWAPI!PathIsUNCServerA (77ec35b9)
   test    eax,eax
   jne     SHLWAPI!PathIsDirectoryA+0xb2 (77ee75ea) [br=0]
   push    esi
   call    SHLWAPI!PathIsUNCServerShareA (77ee737d)
   test    eax,eax
   je      SHLWAPI!PathIsDirectoryA+0xc1 (77ee75f9) [br=1]
   push    esi
   call    dword ptr [SHLWAPI!_imp__GetFileAttributesA (77ea11d4)]
   cmp     eax,0FFFFFFFFh
   ...
</pre>
<p>Ou seja, para pastas locais a função simplesmente usa a conhecidíssima GetFileAttributes, que retorna o flag 0x10 setado caso se trate de uma pasta, de acordo com a documentação: "The attributes can be one or more of the following values:"</p>

<ul><li>FILE_ATTRIBUTE_ARCHIVE 32 (0x20) A file or directory that is an archive file or directory.</li>

<li>FILE_ATTRIBUTE_COMPRESSED 2048 (0x800) A file or directory that is compressed.</li>

<li>FILE_ATTRIBUTE_DIRECTORY 16 (0x10) The handle that identifies a directory.</li></ul>

<p>Aqui termina nossa dúvida sobre o pequenino bug na documentação. E isso nos lembra também que é sempre bom comparar as coisas da melhor maneira possível. E essa melhor maneira em se tratando de ifs é supor apenas dois valores binário: ou é zero ou é não-zero.</p>

</section>

<span style="float: left;">
 <a href="todo_programador_e_um_filosofo_em_potencial.html">[todo_programador_e_um_filosofo_em_potencial]</a>
 <a href="os_processosfantasma.html">[os_processosfantasma]</a>
</span>
</div>
</div>
</section>
<footer class="footer">
<div class="container">
</div>
<div class="intentionally-blank"></div>
</footer>
</body>
</html>
